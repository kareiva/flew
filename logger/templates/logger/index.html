{% extends "logger/base.html" %}
{% load widget_tweaks %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Free Text Input</h5>
                </div>
                <div class="card-body">
                    <textarea id="qso-input" class="form-control" rows="10" placeholder="Enter QSO data here...">{% if initial_input %}{{ initial_input.input_text }}{% endif %}</textarea>
                    {% if user.is_authenticated %}
                    <div class="mt-3">
                        <div class="input-group">
                            <input type="text" id="save-name" class="form-control" placeholder="Enter a name for this input">
                            <button class="btn btn-primary" id="save-input">Save</button>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">ADIF Output</h5>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <textarea class="form-control" id="adif_output" rows="10" readonly>{% if initial_input %}{{ initial_input.adif_text }}{% endif %}</textarea>
                        {% if user.is_authenticated %}
                        <div class="mt-2">
                            <button type="button" class="btn btn-primary" onclick="saveQSOs()">Save QSOs to Log</button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col">
            <div class="alert alert-info">
                <h5 class="mb-3">Quick Guide</h5>
                <p>Enter your QSO data in free text format. Here are some examples:</p>
                <pre class="mb-3">
2024-01-20                    # Set date for subsequent QSOs
14.074 ly1abc 599            # Frequency before callsign, RST after
58 ly2xyz                    # Minute before callsign (sets time to HH:58)
ly3def ,001 .002            # Sent exchange 001, received exchange 002
ly4ghi 7                    # Single digit 7 sets RST to 57 (phone) or 579 (CW)</pre>
                <p>Special commands:</p>
                <ul>
                    <li><code>mycall CALLSIGN</code> - Set your station callsign</li>
                    <li><code>mygrid GRID</code> - Set your grid square</li>
                    <li><code>default mode=CW</code> - Set default mode</li>
                    <li><code>default band=20m</code> - Set default band</li>
                    <li><code>default freq=14.074</code> - Set default frequency</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const qsoInput = document.getElementById('qso-input');
    const adifOutput = document.getElementById('adif_output');
    const saveNameInput = document.getElementById('save-name');
    const saveButton = document.getElementById('save-input');
    let typingTimer;

    function updateAdif() {
        const text = qsoInput.value;
        if (!text.trim()) {
            adifOutput.value = '';
            return;
        }

        fetch('{% url "parse_text" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: 'text=' + encodeURIComponent(text)
        })
        .then(response => response.json())
        .then(data => {
            if (data.adif) {
                adifOutput.value = data.adif;
            } else {
                adifOutput.value = 'Error parsing input';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            adifOutput.value = 'Error communicating with server';
        });
    }

    qsoInput.addEventListener('input', function() {
        clearTimeout(typingTimer);
        typingTimer = setTimeout(updateAdif, 500);
    });

    if (saveButton) {
        saveButton.addEventListener('click', function() {
            const name = saveNameInput.value.trim();
            const inputText = qsoInput.value.trim();
            const adifText = adifOutput.value.trim();

            if (!name) {
                alert('Please enter a name for this input');
                return;
            }

            if (!inputText) {
                alert('Please enter some QSO data');
                return;
            }

            fetch('{% url "save_input" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: 'name=' + encodeURIComponent(name) + 
                      '&input_text=' + encodeURIComponent(inputText) +
                      '&adif_text=' + encodeURIComponent(adifText)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    saveNameInput.value = '';
                    qsoInput.value = data.input_text;
                    adifOutput.value = data.adif_text;
                    window.location.reload();
                } else {
                    alert('Error saving input');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error communicating with server');
            });
        });
    }

    // Initial update if there's text in the input
    if (qsoInput.value.trim()) {
        updateAdif();
    }
});

function saveQSOs() {
    const adifText = document.getElementById('adif_output').value;
    if (!adifText) {
        alert('No QSOs to save');
        return;
    }

    fetch('{% url "save_qsos" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: 'adif_text=' + encodeURIComponent(adifText)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        if (data.status === 'success') {
            alert(data.message);
            // Clear the input and output areas after successful save
            document.getElementById('qso-input').value = '';
            document.getElementById('adif_output').value = '';
        } else {
            console.error('Save QSOs Error:', data.message);
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Save QSOs Error:', error);
        alert('Error saving QSOs. Please check the console for details.');
    });
}

// Add CSRF token helper function if not already present
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %} 